## GOAL OF THIS SCRIPT: 
# Receive an input of a table with different fields as the columns and unique 
# records as the rows, where each each cells is NULL or marked with "1".  
# Output a table that shows the overlap between each field of how many users 
# were marked "1" for both the first and second field.

# In plan English, each cell of the resulting table describes: Of everyone marked
# "1" for the first issue, what percent were also marked "1" for the second issue?

# For an example if this, check out https://docs.google.com/spreadsheets/d/1jrTEisa2SjCM_JvnlKa2paRWrGprL4TI8GRHGJXDKQg/edit?usp=sharing
# tab "Issue Cross Calculations".


# SET UP WORKSPACE
# Clear workspace
rm(list = ls())

# Add packages
library(dplyr)
library(janitor)
library(tidyr)

# FORMAT INPUT TABLE
# Bring in CSV to work with
donors_issueflags <- read.csv(file = 'donor_flags_full.csv')

# Cut unneeded fields
donors_issueflags <- donors_issueflags %>%
  select(-police_accountability_flag
  )

# Changes '1's to 'One's in the table
donors_issueflags[donors_issueflags=='1']<-'One'

# FORMAT INTERMEDIARY TABLE
# Extract column names of issues
issue_list <- donors_issueflags %>%
  select(-user_id) %>%
  colnames() #%>%
  #noquote(
  #)

# Get a vector with unique combos of every 2 issues in format to use in the function
issue_list_2 <- issue_list

issue_combos <- crossing(issue_list, issue_list_2)
rm(issue_list)
rm(issue_list_2)

# Remove rows with the same issue in both columns
issue_combos <- subset(issue_combos, issue_combos$issue_list!=issue_combos$issue_list_2)

##issue_combos <- issue_combos %>%
##unite(issue_pairs, issue_list, issue_list_copy, sep = ", ")

# CREATE DATAFRAME FOR OUTPUT
issues <- c('temp')
coverage <- c(0)
issue_cross_output <- data.frame(issues, coverage)
rm(issues)
rm(coverage)


##

# Make a function
cross_calc <- function(issue_x, issue_y) {
  
  issue_x <- enquo(issue_x)
  issue_y <- enquo(issue_y)
  
  #Two-way tabyl by 2 issues
  t <- donors_issueflags %>%
    tabyl(!!issue_x, !!issue_y) %>%
    adorn_totals(c("row", "col"), fill = 0) %>%
    adorn_title(placement = "combined")
  
  # New field for coverage calculation
  t <- t %>%
    transform(coverage = (One/Total*100))
  
  # Extract issue names
  issues <- colnames(t[1])
  
  # Extract coverage calculation
  coverage <- t[1,5]
  
  # Make a matrix
  t2 <- data.frame(issues, coverage)
  
  # Add new row to issue_cross df
  issue_cross_output <<- rbind(issue_cross_output, t2)
}


# TEST FUNCTION
#cross_calc(anti_trump_flag, census_flag)

# RUN THE LOOP
#for(i in issue_combos) {
#  cross_calc(issue_combos$issue_list, issue_combos$issue_list_2)
#}
  
# RUN THIS SCRIPT
mapply(cross_calc, issue_combos$issue_list, issue_combos$issue_list_2)

####

test_func <- function(issue_x, issue_y) {
  print(issue_x)
  print(issue_y)
}
